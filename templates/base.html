<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>
            {% block title %}{{ config.title | default(value="Blog") }}{%
            endblock %}
        </title>

        <!-- Tailwind + Basecoat CSS -->
        <link rel="stylesheet" href="{{ get_url(path='css/style.css') }}" />

        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap" rel="stylesheet">

        <!-- Determine theme before loading syntax highlighting -->
        <script>
            (() => {
                const stored = localStorage.getItem("themeMode");
                const isDark = stored
                    ? stored === "dark"
                    : matchMedia("(prefers-color-scheme: dark)").matches;

                if (isDark) {
                    document.documentElement.classList.add("dark");
                }
            })();
        </script>

        <!-- Syntax highlighting themes -->
        <link rel="stylesheet" href="{{ get_url(path='syntax-dark.css') }}" id="syntax-dark" />
        <link rel="stylesheet" href="{{ get_url(path='syntax-light.css') }}" id="syntax-light" />

        <!-- KaTeX for math rendering -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        />

        {% block head %}{% endblock %}
    </head>
    <body class="min-h-screen bg-background text-foreground">
        <main>{% block content %}{% endblock %}</main>

        {% block footer %}{% endblock %}

        <!-- Basecoat JS for interactive components -->
        <script
            src="{{ get_url(path='js/basecoat/basecoat.min.js') }}"
            defer
        ></script>
        <!-- Basecoat sidebar component -->
        <script
            src="{{ get_url(path='js/basecoat/sidebar.min.js') }}"
            defer
        ></script>
        <!-- Sidebar toggle for mobile -->
        <script src="{{ get_url(path='js/sidebar-toggle.js') }}" defer></script>
        <!-- Custom tabs for panel-tabset -->
        <script src="{{ get_url(path='js/tabs.js') }}" defer></script>
        <!-- Search functionality -->
        <script src="{{ get_url(path='js/search.js') }}" defer></script>
        <script>
            (() => {
                const apply = (dark) => {
                    document.documentElement.classList.toggle("dark", dark);

                    // Toggle syntax highlighting themes via media attribute
                    const darkSyntax = document.getElementById("syntax-dark");
                    const lightSyntax = document.getElementById("syntax-light");
                    if (darkSyntax && lightSyntax) {
                        darkSyntax.media = dark ? "all" : "not all";
                        lightSyntax.media = dark ? "not all" : "all";
                    }

                    try {
                        localStorage.setItem(
                            "themeMode",
                            dark ? "dark" : "light",
                        );
                    } catch (_) {}
                };

                document.addEventListener("basecoat:theme", (event) => {
                    const mode = event.detail?.mode;
                    apply(
                        mode === "dark"
                            ? true
                            : mode === "light"
                              ? false
                              : !document.documentElement.classList.contains(
                                    "dark",
                                ),
                    );
                });
            })();
        </script>
        <!-- KaTeX auto-render -->
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        ></script>
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
            onload="renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ]
            });"
        ></script>
        {% block scripts %}{% endblock %}
    </body>
</html>
