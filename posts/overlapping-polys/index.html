<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>
            Fishnets and overlapping polygons | Josiah Parry
        </title>

        <!-- Tailwind + Basecoat CSS -->
        <link rel="stylesheet" href="https://josiah.rs/css/style.css" />

        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap" rel="stylesheet">

        <!-- Determine theme before loading syntax highlighting -->
        <script>
            (() => {
                const stored = localStorage.getItem("themeMode");
                // Use stored preference if exists, otherwise always default to dark
                const isDark = stored ? stored === "dark" : true;

                if (isDark) {
                    document.documentElement.classList.add("dark");
                }
            })();
        </script>

        <!-- Syntax highlighting themes -->
        <link rel="stylesheet" href="https://josiah.rs/syntax-dark.css" id="syntax-dark" />
        <link rel="stylesheet" href="https://josiah.rs/syntax-light.css" id="syntax-light" />

        <!-- KaTeX for math rendering -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        />

        
    </head>
    <body class="min-h-screen bg-background text-foreground">
        <main> <button
    data-drawer-target="default-sidebar"
    data-drawer-toggle="default-sidebar"
    aria-controls="default-sidebar"
    type="button"
    class="text-heading bg-transparent box-border border border-transparent hover:bg-neutral-secondary-medium focus:ring-4 focus:ring-neutral-tertiary font-medium leading-5 rounded-base ms-3 mt-3 text-sm p-2 focus:outline-none inline-flex sm:hidden"
>
    <span class="sr-only">Open sidebar</span>
    <svg
        class="w-6 h-6"
        aria-hidden="true"
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        fill="none"
        viewBox="0 0 24 24"
    >
        <path
            stroke="currentColor"
            stroke-linecap="round"
            stroke-width="2"
            d="M5 7h14M5 12h14M5 17h10"
        />
    </svg>
</button>

<aside
    id="default-sidebar"
    class="fixed top-0 left-0 z-40 w-64 h-full transition-transform -translate-x-full sm:translate-x-0"
    aria-label="Sidebar"
>
    <div class="flex h-full flex-col bg-sidebar border-e border-default">
        <!-- Header: Title + Dark Mode -->
        <div class="flex items-center justify-between p-4">
            <a
                href="https://josiah.rs"
                class="font-mono font-semibold italic text-lg"
            >
                Josiah Parry
            </a>
            <button
                type="button"
                aria-label="Toggle dark mode"
                onclick="document.dispatchEvent(new CustomEvent('basecoat:theme'))"
                class="btn-sm-ghost text-muted-foreground hover:text-foreground"
            >
                <span class="hidden dark:block">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <circle cx="12" cy="12" r="4" />
                        <path d="M12 2v2" />
                        <path d="M12 20v2" />
                        <path d="m4.93 4.93 1.41 1.41" />
                        <path d="m17.66 17.66 1.41 1.41" />
                        <path d="M2 12h2" />
                        <path d="M20 12h2" />
                        <path d="m6.34 17.66-1.41 1.41" />
                        <path d="m19.07 4.93-1.41 1.41" />
                    </svg>
                </span>
                <span class="block dark:hidden">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
                    </svg>
                </span>
            </button>
        </div>

        <!-- Search -->
        <div class="px-4 pb-4 relative">
            <input
                type="search"
                placeholder="Search..."
                class="input w-full text-sm bg-muted/50 border border-border"
                id="search-input"
            />
            <div
                id="search-results"
                class="hidden absolute top-full left-4 -mt-1 w-96 max-h-96 overflow-y-auto bg-background border border-border rounded-lg shadow-lg z-50 p-2"
            ></div>
        </div>

        <!-- Content: Navigation -->
        <div class="overflow-y-auto px-4">
            <ul class="flex flex-col gap-1">
                <li>
                    <a
                        href="https://josiah.rs"
                        class="block py-2 text-sm pl-3 transition-colors hover:bg-sidebar-accent/50"
                    >
                        Home
                    </a>
                </li>
                <li>
                    <a
                        href="https://josiah.rs/about/"
                        class="block py-2 text-sm pl-3 transition-colors hover:bg-sidebar-accent/50"
                    >
                        About
                    </a>
                </li>
                <li>
                    <a
                        href="https://josiah.rs/posts/"
                        class="block py-2 text-sm pl-3 transition-colors font-medium border-l-2 border-primary -ml-px bg-sidebar-accent"
                    >
                        Posts
                    </a>
                </li>
            </ul>

            <!-- Socials -->
            <div
                class="mt-4 block py-2 transition-colors font-medium px-3 text-sm bg-sidebar-accent"
            >
                <h2
                    class="text-sm font-medium tracking-tight mb-2 text-muted-foreground border-b border-muted-foreground/20 pb-1"
                >
                    Socials
                </h2>
                <ul class="space-y-1.5">
                    <li
                        class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 256 256"
                            class="w-4 h-4"
                        >
                            <rect width="256" height="256" fill="none" />
                            <polygon
                                points="160 128 112 96 112 160 160 128"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M24,128c0,29.91,3.07,47.45,5.41,56.47A16,16,0,0,0,39,195.42C72.52,208.35,128,208,128,208s55.48.35,89-12.58a16,16,0,0,0,9.63-10.95c2.34-9,5.41-26.56,5.41-56.47s-3.07-47.45-5.41-56.47a16,16,0,0,0-9.63-11C183.48,47.65,128,48,128,48s-55.48-.35-89,12.58a16,16,0,0,0-9.63,11C27.07,80.54,24,98.09,24,128Z"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                        </svg>
                        <a
                            href="https://www.youtube.com/@josiahparry"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-sm"
                            >YouTube</a
                        >
                    </li>
                    <li
                        class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 256 256"
                            class="w-4 h-4"
                        >
                            <rect width="256" height="256" fill="none" />
                            <rect
                                x="32"
                                y="32"
                                width="192"
                                height="192"
                                rx="8"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <line
                                x1="120"
                                y1="112"
                                x2="120"
                                y2="176"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <line
                                x1="88"
                                y1="112"
                                x2="88"
                                y2="176"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M120,140a28,28,0,0,1,56,0v36"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <circle cx="88" cy="84" r="12" />
                        </svg>
                        <a
                            href="https://www.linkedin.com/in/josiahparry"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-sm"
                            >LinkedIn</a
                        >
                    </li>
                    <li
                        class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 256 256"
                            class="w-4 h-4"
                        >
                            <rect width="256" height="256" fill="none" />
                            <path
                                d="M119.83,56A52,52,0,0,0,76,32a51.92,51.92,0,0,0-3.49,44.7A49.28,49.28,0,0,0,64,104v8a48,48,0,0,0,48,48h48a48,48,0,0,0,48-48v-8a49.28,49.28,0,0,0-8.51-27.3A51.92,51.92,0,0,0,196,32a52,52,0,0,0-43.83,24Z"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M104,232V192a32,32,0,0,1,32-32h0a32,32,0,0,1,32,32v40"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M104,208H72a32,32,0,0,1-32-32A32,32,0,0,0,8,144"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                        </svg>
                        <a
                            href="http://github.com/josiahparry/"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-sm"
                            >GitHub</a
                        >
                    </li>
                    <li
                        class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 256 256"
                            class="w-4 h-4"
                        >
                            <rect width="256" height="256" fill="none" />
                            <path
                                d="M160,224H72a32,32,0,0,1-32-32V72A32,32,0,0,1,72,40H184a32,32,0,0,1,32,32v72a32,32,0,0,1-32,32H40"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M128,136V104a24,24,0,0,0-48,0v32"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M176,136V104a24,24,0,0,0-48,0"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                        </svg>
                        <a
                            href="https://fosstodon.org/@josi"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-sm"
                            >Mastodon</a
                        >
                    </li>
                    <li
                        class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 16 16"
                            class="w-4 h-4"
                            fill="currentColor"
                        >
                            <path
                                d="M3.468 1.948C5.303 3.325 7.276 6.118 8 7.616c.725-1.498 2.698-4.29 4.532-5.668C13.855.955 16 .186 16 2.632c0 .489-.28 4.105-.444 4.692-.572 2.04-2.653 2.561-4.504 2.246 3.236.551 4.06 2.375 2.281 4.2-3.376 3.464-4.852-.87-5.23-1.98-.07-.204-.103-.3-.103-.218 0-.081-.033.014-.102.218-.379 1.11-1.855 5.444-5.231 1.98-1.778-1.825-.955-3.65 2.28-4.2-1.85.315-3.932-.205-4.503-2.246C.28 6.737 0 3.12 0 2.632 0 .186 2.145.955 3.468 1.948"
                            />
                        </svg>
                        <a
                            href="https://bsky.app/profile/josiahparry.com"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-sm"
                            >Bluesky</a
                        >
                    </li>
                </ul>
            </div>
        </div>
    </div>
</aside>


<div class="p-12 sm:ml-64">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-medium italic mb-2">Fishnets and overlapping polygons</h1>

         
        <div class="flex flex-wrap gap-2 mb-4">
            
            <a
                href="/categories/r"
                class="badge-secondary cursor pointer"
                >r</a
            >
            
            <a
                href="/categories/spatial"
                class="badge-secondary cursor pointer"
                >spatial</a
            >
            
            <a
                href="/categories/tutorial"
                class="badge-secondary cursor pointer"
                >tutorial</a
            >
            
        </div>
         

        <div class="flex gap-8 mb-6 text-sm">
            
            <div>
                <span class="text-muted-foreground font-mono font-medium"
                    >November 17, 2022</span
                >
            </div>
            
        </div>

        <div class="josi-prose"><script src="index_files/libs/core-js-2.5.3/shim.min.js"></script>
<script src="index_files/libs/react-18.2.0/react.min.js"></script>
<script src="index_files/libs/react-18.2.0/react-dom.min.js"></script>
<script src="index_files/libs/reactwidget-2.0.0/react-tools.js"></script>
<link href="index_files/libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="index_files/libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="index_files/libs/reactable-0.4.5/reactable.css" rel="stylesheet" />
<script src="index_files/libs/reactable-binding-0.4.5/reactable.js"></script>
<p>Today a question was asked in the geocompr discord. I wanted to share
part of the solution as I think it covers 2 helpful things:</p>
<ul>
<li>making a fishnet grid</li>
<li>calculating the area of overlap between two polygons</li>
</ul>
<p>For this example I’m using data from the <a href="http://gis.atlantaga.gov/?page=OPEN-DATA-HUB">Atlanta GIS Open Data
Portal</a>. Specifically
using the <a href="https://dpcd-coaplangis.opendata.arcgis.com/maps/future-land-use-">future land use
polygons</a>.</p>
<p>I’ve downloaded a local copy of the data as a geojson. But you can read
it using the ArcGIS Feature Server it is hosted on.</p>
<h3 id="objective">Objective</h3>
<p>Create a map of Atlanta, visualized as a hexagon grid, that displays the
amount of planned mixed use zoning. This will be done in the following
sequence:</p>
<ol>
<li>Creating a fishnet (hexagon) grid over the city</li>
<li>Creating intersected polygons</li>
<li>Calculate the area of intersected polygons</li>
<li>Join back to the original fishnet grid</li>
<li>visualized.</li>
</ol>
<h3 id="mixed-use-zoning">Mixed-use zoning</h3>
<p>Start by loading sf, dplyr, and ggplot2. sf for our spatial work, dplyr
for making our lives easier, and ggplot2 for a bad map later.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">library</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>sf<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r"><span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">library</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>dplyr<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r"><span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">library</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>ggplot2<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></code></pre>
<p>We read in our data (mine is local). You can use the commented out code
to read directly from the ArcGIS feature server.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-comment z-line z-number-sign z-r"><span class="z-punctuation z-definition z-comment z-r">#</span> read from the ArcGIS feature server
</span></span><span class="z-source z-r"><span class="z-comment z-line z-number-sign z-r"><span class="z-punctuation z-definition z-comment z-r">#</span> st_read(&quot;https://services5.arcgis.com/5RxyIIJ9boPdptdo/arcgis/rest/services/Land_Use_Future/FeatureServer/0/query?outFields=*&amp;where=1%3D1&amp;f=geojson&quot;)
</span></span><span class="z-source z-r">
</span><span class="z-source z-r">future_land_use <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">read_sf</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>Future_Land_Use_.geojson<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">mutate</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-variable z-parameter z-r">geometry</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">st_make_valid</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>geometry<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></code></pre>
<p>Let’s look at the different land use descriptions.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r">future_land_use <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">st_drop_geometry</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">count</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>LANDUSEDESC<span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-variable z-parameter z-r">sort</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-constant z-language z-r">TRUE</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">  reactable<span class="z-punctuation z-accessor z-colons z-r">::</span><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">reactable</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></code></pre>
<div class="reactable html-widget html-fill-item" id="htmlwidget-69e006ce736600915a0c" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-69e006ce736600915a0c">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"LANDUSEDESC":["Open Space","Low-Density Commercial","Medium-Density Residential","Low-Density Residential","Mixed-Use","Single-Family Residential","High-Density Residential","Community Facilities","Industrial","Office/Institutional","Mixed-Use Medium-Density","Mixed-Use Low-Density","Mixed-Use High-Density","High-Density Commercial","Very High-Density Residential","Mixed Use-High Density","Transportation/Communications/Utilities","Mixed Use-Low Density","Office/Institutional/Residential","Private Open Space","High-Density Mixed-Use","Mixed Use-Medium Density","Business Park","Industrial-Mixed Use",null],"n":[385,275,266,179,137,115,112,89,81,50,34,33,23,22,22,8,7,6,4,4,3,2,1,1,1]},"columns":[{"id":"LANDUSEDESC","name":"LANDUSEDESC","type":"character"},{"id":"n","name":"n","type":"numeric"}],"dataKey":"44ca7976bdd855e4c8ea13b049e53c79"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
<p>To see a disgusting map with a bad legend run the following.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r">future_land_use <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">ggplot</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">aes</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-variable z-parameter z-r">fill</span> <span class="z-keyword z-operator z-assignment z-r">=</span> LANDUSEDESC<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-arithmetic z-r">+</span>
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">geom_sf</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-variable z-parameter z-r">lwd</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-constant z-numeric z-float z-decimal z-r">0<span class="z-punctuation z-separator z-decimal z-r">.</span>15</span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-variable z-parameter z-r">color</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>black<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></code></pre>
<p>We can see that there are a bunch of different descriptions for
different types of mixed use zoning. Let’s filter down to descriptions
that have <code>"Mixed-Use"</code> or <code>"Mixed Use"</code> and visualize them.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-comment z-line z-number-sign z-r"><span class="z-punctuation z-definition z-comment z-r">#</span> how much area of mixed use land use?
</span></span><span class="z-source z-r">mixed_use <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> future_land_use <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">filter</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">grepl</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>Mixed-Use|Mixed Use<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span> <span class="z-punctuation z-separator z-arguments z-r">,</span> LANDUSEDESC<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> 
</span><span class="z-source z-r">
</span><span class="z-source z-r"><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">ggplot</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-arithmetic z-r">+</span>
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">geom_sf</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-variable z-parameter z-r">data</span> <span class="z-keyword z-operator z-assignment z-r">=</span> mixed_use<span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-variable z-parameter z-r">fill</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>blue<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-variable z-parameter z-r">color</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-constant z-language z-r">NA</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-arithmetic z-r">+</span>
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">theme_void</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></code></pre>
<p><img src="https://josiah.rs/posts/overlapping-polys/index_files/figure-commonmark/unnamed-chunk-5-1.png" alt="" /></p>
<h3 id="making-a-fishnet-grid">Making a fishnet grid</h3>
<p>Having made a fishnet grid quite a few times, I’ve got this handy
function. In essence we create a grid over our target geometry and we
keep only those locations from the grid that intersect eachother. If we
dont’, we have a square shaped grid.</p>
<p>It is important that you create an ID for the grid, otherwise when we
intersect later you’ll not know what is being intersected.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-meta z-function z-name z-r"><span class="z-entity z-name z-function z-r">make_fishnet</span> </span><span class="z-meta z-function z-r"><span class="z-keyword z-operator z-assignment z-r">&lt;-</span> </span><span class="z-meta z-function z-r"><span class="z-storage z-type z-function z-r">function</span></span><span class="z-meta z-function z-parameters z-r"><span class="z-punctuation z-section z-parameters z-begin z-r">(</span><span class="z-variable z-parameter z-r">geometry</span><span class="z-punctuation z-separator z-parameters z-r">,</span> <span class="z-variable z-parameter z-r">n</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-constant z-numeric z-float z-decimal z-r">10</span><span class="z-punctuation z-separator z-parameters z-r">,</span> <span class="z-variable z-parameter z-r">hex</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-constant z-language z-r">TRUE</span><span class="z-punctuation z-section z-parameters z-end z-r">)</span></span> <span class="z-punctuation z-section z-braces z-begin z-r">{</span>
</span><span class="z-source z-r">  g <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">st_make_grid</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>geometry<span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-variable z-parameter z-r">square</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-keyword z-operator z-logical z-r">!</span>hex<span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-variable z-parameter z-r">n</span> <span class="z-keyword z-operator z-assignment z-r">=</span> n<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r">  g<span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-single z-begin z-r">[</span></span><span class="z-meta z-item-access z-r"><span class="z-meta z-item-access z-arguments z-r"><span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">lengths</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">st_intersects</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>g<span class="z-punctuation z-separator z-arguments z-r">,</span> geometry<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">!=</span> <span class="z-constant z-numeric z-float z-decimal z-r">0</span></span></span><span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-single z-end z-r">]</span></span> 
</span><span class="z-source z-r"><span class="z-punctuation z-section z-braces z-end z-r">}</span>
</span><span class="z-source z-r">
</span><span class="z-source z-r">
</span><span class="z-source z-r">grd <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">make_fishnet</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>future_land_use<span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-variable z-parameter z-r">n</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-constant z-numeric z-float z-decimal z-r">40</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">st_as_sf</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">mutate</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-variable z-parameter z-r">hex_id</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">row_number</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r">
</span><span class="z-source z-r"><span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">plot</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>grd<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></code></pre>
<p><img src="https://josiah.rs/posts/overlapping-polys/index_files/figure-commonmark/unnamed-chunk-6-1.png" alt="" /></p>
<p>Man, I love maps of sequential IDs.</p>
<p>Next, we split our mixed use polygons based on the hexagons.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-comment z-line z-number-sign z-r"><span class="z-punctuation z-definition z-comment z-r">#</span> how much area in each hexagon
</span></span><span class="z-source z-r">lu_intersects <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">st_intersection</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>mixed_use<span class="z-punctuation z-separator z-arguments z-r">,</span> grd<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">Warning: attribute variables are assumed to be spatially constant throughout
</span><span class="z-text z-plain">all geometries
</span></code></pre>
<p>Then we calculate the area of each resultant shape.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r">overlap_area <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> lu_intersects <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">mutate</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-variable z-parameter z-r">area</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">st_area</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>geometry<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> 
</span><span class="z-source z-r">
</span><span class="z-source z-r"><span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">plot</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>overlap_area<span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-single z-begin z-r">[</span></span><span class="z-meta z-item-access z-r"><span class="z-meta z-item-access z-arguments z-r"><span class="z-punctuation z-separator z-parameters z-r">,</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>area<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span></span></span><span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-single z-end z-r">]</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></code></pre>
<p><img src="https://josiah.rs/posts/overlapping-polys/index_files/figure-commonmark/unnamed-chunk-8-1.png" alt="" /></p>
<p>The next step here is to take the split polygons, and join the data back
to the hexagons. I use a right join because they don’t get enough love.
And also because if you try to do a join with two sf objects they’ll
scream!!.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-comment z-line z-number-sign z-r"><span class="z-punctuation z-definition z-comment z-r">#</span> join it back to the grid
</span></span><span class="z-source z-r">hex_area_overlap <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">st_drop_geometry</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>overlap_area<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">select</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>hex_id<span class="z-punctuation z-separator z-arguments z-r">,</span> area<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">right_join</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>grd<span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-variable z-parameter z-r">by</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>hex_id<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">st_as_sf</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> 
</span><span class="z-source z-r">
</span><span class="z-source z-r">hex_area_overlap
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">Simple feature collection with 1381 features and 2 fields
</span><span class="z-text z-plain">Geometry type: POLYGON
</span><span class="z-text z-plain">Dimension:     XY
</span><span class="z-text z-plain">Bounding box:  xmin: -84.55738 ymin: 33.64417 xmax: -84.28635 ymax: 33.88926
</span><span class="z-text z-plain">Geodetic CRS:  WGS 84
</span><span class="z-text z-plain"># A tibble: 1,381 × 3
</span><span class="z-text z-plain">   hex_id    area                                                              x
</span><span class="z-text z-plain">    &lt;int&gt;   [m^2]                                                  &lt;POLYGON [°]&gt;
</span><span class="z-text z-plain"> 1     72 160485. ((-84.5182 33.65548, -84.52146 33.65737, -84.52146 33.66114, …
</span><span class="z-text z-plain"> 2     84  44538. ((-84.51493 33.64983, -84.5182 33.65171, -84.5182 33.65548, -…
</span><span class="z-text z-plain"> 3     85 176134. ((-84.51493 33.66114, -84.5182 33.66302, -84.5182 33.66679, -…
</span><span class="z-text z-plain"> 4     87   5049. ((-84.51493 33.68376, -84.5182 33.68565, -84.5182 33.68942, -…
</span><span class="z-text z-plain"> 5     97 380145. ((-84.51167 33.65548, -84.51493 33.65737, -84.51493 33.66114,…
</span><span class="z-text z-plain"> 6    100 110821. ((-84.51167 33.68942, -84.51493 33.6913, -84.51493 33.69507, …
</span><span class="z-text z-plain"> 7    106   8232. ((-84.51167 33.75729, -84.51493 33.75917, -84.51493 33.76294,…
</span><span class="z-text z-plain"> 8    110 109249. ((-84.5084 33.64983, -84.51167 33.65171, -84.51167 33.65548, …
</span><span class="z-text z-plain"> 9    111 150687. ((-84.5084 33.66114, -84.51167 33.66302, -84.51167 33.66679, …
</span><span class="z-text z-plain">10    113 141654. ((-84.5084 33.68376, -84.51167 33.68565, -84.51167 33.68942, …
</span><span class="z-text z-plain"># ℹ 1,371 more rows
</span></code></pre>
<p>Now plot it!</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">ggplot</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>hex_area_overlap<span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">aes</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-variable z-parameter z-r">fill</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">as.numeric</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>area<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-arithmetic z-r">+</span>
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">geom_sf</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-variable z-parameter z-r">color</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>black<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-variable z-parameter z-r">lwd</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-constant z-numeric z-float z-decimal z-r">0<span class="z-punctuation z-separator z-decimal z-r">.</span>15</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-arithmetic z-r">+</span>
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">theme_void</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-arithmetic z-r">+</span>
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">scale_fill_viridis_c</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    <span class="z-variable z-parameter z-r">option</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>plasma<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> 
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    <span class="z-variable z-parameter z-r">na.value</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-constant z-language z-r">NA</span><span class="z-punctuation z-separator z-arguments z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    <span class="z-variable z-parameter z-r">labels</span> <span class="z-keyword z-operator z-assignment z-r">=</span> scales<span class="z-punctuation z-accessor z-colons z-r">::</span>comma
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    <span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-arithmetic z-r">+</span>
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">labs</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-variable z-parameter z-r">fill</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>Area of mixed-use zoning (m)<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></code></pre>
<p><img src="https://josiah.rs/posts/overlapping-polys/index_files/figure-commonmark/unnamed-chunk-10-1.png" alt="" /></p>
</div>
    </div>
</div>
</main>

        

        <!-- Basecoat JS for interactive components -->
        <script
            src="https://josiah.rs/js/basecoat/basecoat.min.js"
            defer
        ></script>
        <!-- Basecoat sidebar component -->
        <script
            src="https://josiah.rs/js/basecoat/sidebar.min.js"
            defer
        ></script>
        <!-- Sidebar toggle for mobile -->
        <script src="https://josiah.rs/js/sidebar-toggle.js" defer></script>
        <!-- Custom tabs for panel-tabset -->
        <script src="https://josiah.rs/js/tabs.js" defer></script>
        <!-- Search functionality -->
        <script src="https://josiah.rs/js/search.js" defer></script>
        <script>
            (() => {
                const apply = (dark) => {
                    document.documentElement.classList.toggle("dark", dark);

                    // Toggle syntax highlighting themes via media attribute
                    const darkSyntax = document.getElementById("syntax-dark");
                    const lightSyntax = document.getElementById("syntax-light");
                    if (darkSyntax && lightSyntax) {
                        darkSyntax.media = dark ? "all" : "not all";
                        lightSyntax.media = dark ? "not all" : "all";
                    }

                    try {
                        localStorage.setItem(
                            "themeMode",
                            dark ? "dark" : "light",
                        );
                    } catch (_) {}
                };

                document.addEventListener("basecoat:theme", (event) => {
                    const mode = event.detail?.mode;
                    apply(
                        mode === "dark"
                            ? true
                            : mode === "light"
                              ? false
                              : !document.documentElement.classList.contains(
                                    "dark",
                                ),
                    );
                });
            })();
        </script>
        <!-- KaTeX auto-render -->
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        ></script>
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
            onload="renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ]
            });"
        ></script>
        
    </body>
</html>
