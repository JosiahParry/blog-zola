<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>
            Valve: putting R in production | Josiah Parry
        </title>

        <!-- Tailwind + Basecoat CSS -->
        <link rel="stylesheet" href="https://josiah.rs/css/style.css" />

        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap" rel="stylesheet">

        <!-- Determine theme before loading syntax highlighting -->
        <script>
            (() => {
                const stored = localStorage.getItem("themeMode");
                // Use stored preference if exists, otherwise always default to dark
                const isDark = stored ? stored === "dark" : true;

                if (isDark) {
                    document.documentElement.classList.add("dark");
                }
            })();
        </script>

        <!-- Syntax highlighting themes -->
        <link rel="stylesheet" href="https://josiah.rs/syntax-dark.css" id="syntax-dark" />
        <link rel="stylesheet" href="https://josiah.rs/syntax-light.css" id="syntax-light" />

        <!-- KaTeX for math rendering -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        />

        
    </head>
    <body class="min-h-screen bg-background text-foreground">
        <main> <button
    data-drawer-target="default-sidebar"
    data-drawer-toggle="default-sidebar"
    aria-controls="default-sidebar"
    type="button"
    class="text-heading bg-transparent box-border border border-transparent hover:bg-neutral-secondary-medium focus:ring-4 focus:ring-neutral-tertiary font-medium leading-5 rounded-base ms-3 mt-3 text-sm p-2 focus:outline-none inline-flex sm:hidden"
>
    <span class="sr-only">Open sidebar</span>
    <svg
        class="w-6 h-6"
        aria-hidden="true"
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        fill="none"
        viewBox="0 0 24 24"
    >
        <path
            stroke="currentColor"
            stroke-linecap="round"
            stroke-width="2"
            d="M5 7h14M5 12h14M5 17h10"
        />
    </svg>
</button>

<aside
    id="default-sidebar"
    class="fixed top-0 left-0 z-40 w-64 h-full transition-transform -translate-x-full sm:translate-x-0"
    aria-label="Sidebar"
>
    <div class="flex h-full flex-col bg-sidebar border-e border-default">
        <!-- Header: Title + Dark Mode -->
        <div class="flex items-center justify-between p-4">
            <a
                href="https://josiah.rs"
                class="font-mono font-semibold italic text-lg"
            >
                Josiah Parry
            </a>
            <button
                type="button"
                aria-label="Toggle dark mode"
                onclick="document.dispatchEvent(new CustomEvent('basecoat:theme'))"
                class="btn-sm-ghost text-muted-foreground hover:text-foreground"
            >
                <span class="hidden dark:block">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <circle cx="12" cy="12" r="4" />
                        <path d="M12 2v2" />
                        <path d="M12 20v2" />
                        <path d="m4.93 4.93 1.41 1.41" />
                        <path d="m17.66 17.66 1.41 1.41" />
                        <path d="M2 12h2" />
                        <path d="M20 12h2" />
                        <path d="m6.34 17.66-1.41 1.41" />
                        <path d="m19.07 4.93-1.41 1.41" />
                    </svg>
                </span>
                <span class="block dark:hidden">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
                    </svg>
                </span>
            </button>
        </div>

        <!-- Search -->
        <div class="px-4 pb-4 relative">
            <input
                type="search"
                placeholder="Search..."
                class="input w-full text-sm bg-muted/50 border border-border"
                id="search-input"
            />
            <div
                id="search-results"
                class="hidden absolute top-full left-4 -mt-1 w-96 max-h-96 overflow-y-auto bg-background border border-border rounded-lg shadow-lg z-50 p-2"
            ></div>
        </div>

        <!-- Content: Navigation -->
        <div class="overflow-y-auto px-4">
            <ul class="flex flex-col gap-1">
                <li>
                    <a
                        href="https://josiah.rs"
                        class="block py-2 text-sm pl-3 transition-colors hover:bg-sidebar-accent/50"
                    >
                        Home
                    </a>
                </li>
                <li>
                    <a
                        href="https://josiah.rs/about/"
                        class="block py-2 text-sm pl-3 transition-colors hover:bg-sidebar-accent/50"
                    >
                        About
                    </a>
                </li>
                <li>
                    <a
                        href="https://josiah.rs/posts/"
                        class="block py-2 text-sm pl-3 transition-colors font-medium border-l-2 border-primary -ml-px bg-sidebar-accent"
                    >
                        Posts
                    </a>
                </li>
            </ul>

            <!-- Socials -->
            <div
                class="mt-4 block py-2 transition-colors font-medium px-3 text-sm bg-sidebar-accent"
            >
                <h2
                    class="text-sm font-medium tracking-tight mb-2 text-muted-foreground border-b border-muted-foreground/20 pb-1"
                >
                    Socials
                </h2>
                <ul class="space-y-1.5">
                    <li
                        class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 256 256"
                            class="w-4 h-4"
                        >
                            <rect width="256" height="256" fill="none" />
                            <polygon
                                points="160 128 112 96 112 160 160 128"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M24,128c0,29.91,3.07,47.45,5.41,56.47A16,16,0,0,0,39,195.42C72.52,208.35,128,208,128,208s55.48.35,89-12.58a16,16,0,0,0,9.63-10.95c2.34-9,5.41-26.56,5.41-56.47s-3.07-47.45-5.41-56.47a16,16,0,0,0-9.63-11C183.48,47.65,128,48,128,48s-55.48-.35-89,12.58a16,16,0,0,0-9.63,11C27.07,80.54,24,98.09,24,128Z"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                        </svg>
                        <a
                            href="https://www.youtube.com/@josiahparry"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-sm"
                            >YouTube</a
                        >
                    </li>
                    <li
                        class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 256 256"
                            class="w-4 h-4"
                        >
                            <rect width="256" height="256" fill="none" />
                            <rect
                                x="32"
                                y="32"
                                width="192"
                                height="192"
                                rx="8"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <line
                                x1="120"
                                y1="112"
                                x2="120"
                                y2="176"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <line
                                x1="88"
                                y1="112"
                                x2="88"
                                y2="176"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M120,140a28,28,0,0,1,56,0v36"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <circle cx="88" cy="84" r="12" />
                        </svg>
                        <a
                            href="https://www.linkedin.com/in/josiahparry"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-sm"
                            >LinkedIn</a
                        >
                    </li>
                    <li
                        class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 256 256"
                            class="w-4 h-4"
                        >
                            <rect width="256" height="256" fill="none" />
                            <path
                                d="M119.83,56A52,52,0,0,0,76,32a51.92,51.92,0,0,0-3.49,44.7A49.28,49.28,0,0,0,64,104v8a48,48,0,0,0,48,48h48a48,48,0,0,0,48-48v-8a49.28,49.28,0,0,0-8.51-27.3A51.92,51.92,0,0,0,196,32a52,52,0,0,0-43.83,24Z"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M104,232V192a32,32,0,0,1,32-32h0a32,32,0,0,1,32,32v40"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M104,208H72a32,32,0,0,1-32-32A32,32,0,0,0,8,144"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                        </svg>
                        <a
                            href="http://github.com/josiahparry/"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-sm"
                            >GitHub</a
                        >
                    </li>
                    <li
                        class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 256 256"
                            class="w-4 h-4"
                        >
                            <rect width="256" height="256" fill="none" />
                            <path
                                d="M160,224H72a32,32,0,0,1-32-32V72A32,32,0,0,1,72,40H184a32,32,0,0,1,32,32v72a32,32,0,0,1-32,32H40"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M128,136V104a24,24,0,0,0-48,0v32"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M176,136V104a24,24,0,0,0-48,0"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                        </svg>
                        <a
                            href="https://fosstodon.org/@josi"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-sm"
                            >Mastodon</a
                        >
                    </li>
                    <li
                        class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 16 16"
                            class="w-4 h-4"
                            fill="currentColor"
                        >
                            <path
                                d="M3.468 1.948C5.303 3.325 7.276 6.118 8 7.616c.725-1.498 2.698-4.29 4.532-5.668C13.855.955 16 .186 16 2.632c0 .489-.28 4.105-.444 4.692-.572 2.04-2.653 2.561-4.504 2.246 3.236.551 4.06 2.375 2.281 4.2-3.376 3.464-4.852-.87-5.23-1.98-.07-.204-.103-.3-.103-.218 0-.081-.033.014-.102.218-.379 1.11-1.855 5.444-5.231 1.98-1.778-1.825-.955-3.65 2.28-4.2-1.85.315-3.932-.205-4.503-2.246C.28 6.737 0 3.12 0 2.632 0 .186 2.145.955 3.468 1.948"
                            />
                        </svg>
                        <a
                            href="https://bsky.app/profile/josiahparry.com"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-sm"
                            >Bluesky</a
                        >
                    </li>
                </ul>
            </div>
        </div>
    </div>
</aside>


<div class="p-12 sm:ml-64">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-medium italic mb-2">Valve: putting R in production</h1>

         
        <div class="flex flex-wrap gap-2 mb-4">
            
            <a
                href="/categories/rust"
                class="badge-secondary cursor pointer"
                >rust</a
            >
            
            <a
                href="/categories/r"
                class="badge-secondary cursor pointer"
                >r</a
            >
            
            <a
                href="/categories/production"
                class="badge-secondary cursor pointer"
                >production</a
            >
            
        </div>
         

        <div class="flex gap-8 mb-6 text-sm">
            
            <div>
                <span class="text-muted-foreground font-mono font-medium"
                    >August 22, 2023</span
                >
            </div>
            
        </div>

        <div class="josi-prose"><p>This blog post is based on my most recent YouTube video. Please give it
a watch!</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/11FM-dxxi3M" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen>
</iframe>
<p>I‚Äôve been grinding on a new tool for a few months now. And I‚Äôm hyped to
formally introduce you to it. It‚Äôs called
<a href="https://valve.josiahparry.com">Valve</a> And Valve is going to make R in
production kick a$$.üî•</p>
<p>We‚Äôve all seen those click bait articles saying ‚ÄúDon‚Äôt Put R in
production‚Äù or telling you that R can‚Äôt make machine learning models for
production. Those ‚Äúhot takes‚Äù are uninformed and can be applied to other
languages such as Python. That‚Äôs a bunch of malarkey.</p>
<p><a href="https://towardsdatascience.com/dont-use-r-in-production-e2f4c9dd4a7b"><img src="images/paste-1.png" style="width:50.0%"
data-fig-align="center" /></a></p>
<p>Let‚Äôs get right down to it. Let‚Äôs talk ‚Äúproduction.‚Äù And let me be
clear: R belongs in production. But we as the R community need to learn
how to do that and be better advocates.</p>
<p>When I say ‚Äúproduction‚Äù I‚Äôm talking about making your code work with any
other system. And that‚Äôs where RESTful APIs come in. If I‚Äôve lost you at
‚ÄúRESTful‚Äù, <a href="https://www.youtube.com/watch?v=w4yHEQWct20&amp;list=UULFX78SUhrloA6Cn3aW_e8C_A&amp;index=22">watch my previous video
here</a>.</p>
<div class="aside">
<p><a href="https://www.youtube.com/watch?v=w4yHEQWct20&amp;list=UULFX78SUhrloA6Cn3aW_e8C_A&amp;index=22"><img src="images/paste-15.png" style="width:75.0%"
data-fig-align="center" /></a></p>
</div>
<p>REST relies on HTTP, which is the foundation of the internet and is a
common tongue. It‚Äôs like if Esperanto actually worked. REST APIs provide
a language-agnostic way to expose functionality over the web.</p>
<p><a href="https://www.rplumber.io/">Plumber</a> is an R package that converts your R
functions into a RESTful API meaning any tool that can communicate in
HTTP can call your R functions. It converts R code like this into an
http endpoint.</p>
<p>At it‚Äôs core Valve is a web server that runs multiple {plumber} APIs in
parallel. Valve spins up and down plumber APIs as needed.</p>
<p><img src="images/paste-21.png" style="width:75.0%"
data-fig-align="center" /></p>
<p>It‚Äôs designed to work with any existing plumber API. And because of that
it supports {vetiver} out of the box.</p>
<div class="aside">
<img src="images/paste-22.png" style="width:50.0%" />
</div>
<p>Vetiver is a framework built by Julia Silge and Isabel Zimmerman from
Posit that simplifies putting machine learning models built with
tidymodels into a production setting. And since, the goal is R in
production, Valve can be easily integrated into Docker containers and
deployed with DigitalOcean, AWS, Azure, or whatever other orchestration
tools you have available.</p>
<p>Valve is akin to Gunicorn for Flask apps and FastAPI.</p>
<div class="columns">
<div class="column">
<p><img src="https://josiah.rs/posts/valve-for-production/images/gunicor.png" alt="" /></p>
</div>
<div class="column">
<p><img src="https://josiah.rs/posts/valve-for-production/images/flask.png" alt="" /></p>
</div>
<div class="column">
<p><img src="https://josiah.rs/posts/valve-for-production/images/fastapi.png" alt="" /></p>
</div>
</div>
<p>To understand why Valve is so powerful, we need to first understand how
plumber works and its limitations. Plumber works by writing a function
definition and providing annotations using a special comment character
<code>#*</code>. Let‚Äôs take a look at a very simple example.</p>
<p>The three main components of a plumber API are:</p>
<ul>
<li>the function definition</li>
<li>the request type <code>@post</code></li>
<li>endpoint <code>/add-2</code></li>
</ul>
<p>In a nutshell plumber works by spawning a single web server using the
{httpuv} R package. The webserver captures incoming http requests,
captures the provided parameters, body, and requested endpoint. Based on
the endpoint, it passes the parameters to the function. The result is
then ‚Äúserialized‚Äù into the correct output type. By default, this is
<code>json</code>.</p>
<p><img src="https://josiah.rs/posts/valve-for-production/images/plumber-nutshell.png" alt="" /></p>
<p>For example, we might be calling the <code>/add-2</code> endpoint. The process
looks a bit like this. We have a GET request. The endpoint is colored
red. Then the parameters are colored blue. The request is captured by
the web-server. The endpoints are checked. Then the parameters are
passed to the function and the user gets the result.</p>
<p><img src="https://josiah.rs/posts/valve-for-production/images/request.png" alt="" /></p>
<p>You can see how this is powerful! But there is one major thing holding
this back. This is all running in a single R process. R, like Python, is
single threaded. That means each request that comes in has to be added
to a queue. The next request cannot be processed until the previous one
has been.</p>
<p>Valve helps by running multiple plumber APIs concurrently. Valve is
built specifically for plumber, in Rust, and by leveraging the power
Tokio framework. Instead of having a single plumber API and a single R
process handling all requests, there is another web server handling all
incoming requests. This web server is build using Tokio.</p>
<div>
</div>
<p>The app has a number of pre-specified worker threads. Each worker is
capable of taking an incoming request, processing it, and returning a
response. These worker threads will delegate the request to another
plumber API. These plumber APIs are sitting in a connection pool waiting
to be accessed. The APIs will spawn and de-spawn according to the amount
of incoming traffic.</p>
<p><img src="https://josiah.rs/posts/valve-for-production/images/valve.png" alt="" /></p>
<p>What this means is that instead of being able to handle 1 request at a
time, we can handle as many requests as there are workers concurrently.
This allows us to take advantage of more than a single R process at a
time and, as a result, we can utilize more of the compute resources
available to us.</p>
<p>So how do you install Valve? There are two ways in which you can install
Valve. The first is to use the Rust package manager Cargo. This is my
personal recommendation. If you don‚Äôt have Rust and cargo installed,
don‚Äôt worry it is the second easiest language I‚Äôve ever installed.</p>
<p><img src="https://josiah.rs/posts/valve-for-production/images/paste-12.png" alt="" /></p>
<p>Follow this one liner and it‚Äôll handle the installation for you.</p>
<p>To install Valve with cargo run</p>
<pre data-lang="shell" class="language-shell z-code"><code class="language-shell" data-lang="shell"><span class="z-text z-plain">cargo install valve-rs --no-default-features
</span></code></pre>
<p>Doing this will install the Valve binary and make it available to you as
a command line tool. Alternatively, if you want to install valve as an R
package you can do so via the R-universe. The R-universe version has
pre-built binaries for Windows, Mac, and Ubuntu which means you do not
need to have rust installed. But again, its easy, so give it a shot!</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">install.packages</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>valve<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> 
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    <span class="z-variable z-parameter z-r">repos</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">c</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>https://josiahparry.r-universe.dev<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>https://cloud.r-project.org<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></code></pre>
<p>To follow along with the rest of these demos you can check out code in
the <a href="https://github.com/JosiahParry/youtube-tutorials/tree/main/intro-valve">github
repository</a>.</p>
<p>Here I want to demo just how easy it is to use Valve and what the
experience is like. For this simple example we will run a plumber API
with one endpoint <code>/zzz</code> which will sleep for a specified amount of
time. We‚Äôll create a Valve app with 10 workers and plumber APIs.</p>
<pre data-lang="shell" class="language-shell z-code"><code class="language-shell" data-lang="shell"><span class="z-text z-plain">valve -n 10 -w 10
</span></code></pre>
<p>You‚Äôll notice that only one API is spawned at the start. This is because
connections are spawned based on incoming demand. As we send more
requests, the plumber APIs will spawn. If, after a specified amount of
time, they go stale, they will de-spawn. However, you do have the
ability to control the minimum number of plumber APIs.</p>
<pre data-lang="shell" class="language-shell z-code"><code class="language-shell" data-lang="shell"><span class="z-text z-plain">Valve starting at: 127.0.0.1:3000
</span><span class="z-text z-plain">Spawning plumber API at 127.0.0.1:11094
</span></code></pre>
<p>We‚Äôre going to create a simple function <code>sleep()</code> which will call the
zzz endpoint at a specified port for a specified amount of time. We‚Äôll
use <code>furrr</code> to create 10 sessions and call the function 10 times on
valve app.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-meta z-function z-name z-r"><span class="z-entity z-name z-function z-r">sleep</span> </span><span class="z-meta z-function z-r"><span class="z-keyword z-operator z-assignment z-r">&lt;-</span> </span><span class="z-meta z-function z-r"><span class="z-storage z-type z-function z-r">function</span></span><span class="z-meta z-function z-parameters z-r"><span class="z-punctuation z-section z-parameters z-begin z-r">(</span><span class="z-variable z-parameter z-r">port</span><span class="z-punctuation z-separator z-parameters z-r">,</span> <span class="z-variable z-parameter z-r">secs</span><span class="z-punctuation z-section z-parameters z-end z-r">)</span></span> <span class="z-punctuation z-section z-braces z-begin z-r">{</span>
</span><span class="z-source z-r">  httr2<span class="z-punctuation z-accessor z-colons z-r">::</span><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">request</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">        <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">paste0</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>127.0.0.1:<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> port<span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>/sleep?zzz=<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> secs<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    <span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">    httr2<span class="z-punctuation z-accessor z-colons z-r">::</span><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">req_perform</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">    httr2<span class="z-punctuation z-accessor z-colons z-r">::</span><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">resp_body_string</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r"><span class="z-punctuation z-section z-braces z-end z-r">}</span>
</span></code></pre>
<p>Now with the function defined we can use furrr to run the function in
parallel</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">library</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>furrr<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r"><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">plan</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>multisession<span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-variable z-parameter z-r">workers</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-constant z-numeric z-float z-decimal z-r">10</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></code></pre>
<p>We will call the function 10 times using <code>future_map()</code> . The first time
this runs we can see that more plumber APIs are being spawned. This
takes somewhere between 3 and 4 seconds the first time we run it.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r">start <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">Sys.time</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r">furrr<span class="z-punctuation z-accessor z-colons z-r">::</span><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">future_map</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-constant z-numeric z-float z-decimal z-r">1</span><span class="z-keyword z-other z-r">:</span><span class="z-constant z-numeric z-float z-decimal z-r">10</span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-keyword z-other z-r">~</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">sleep</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-constant z-numeric z-float z-decimal z-r">3000</span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-constant z-numeric z-float z-decimal z-r">2</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r">multi_total <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">Sys.time</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-arithmetic z-r">-</span> start
</span><span class="z-source z-r">multi_total 
</span><span class="z-source z-r"><span class="z-comment z-line z-number-sign z-r"><span class="z-punctuation z-definition z-comment z-r">#</span>&gt; Time difference of 3.653488 secs
</span></span></code></pre>
<p>If you watch your terminal, you will see additional plumber connections
being spawned.</p>
<pre data-lang="shell" class="language-shell z-code"><code class="language-shell" data-lang="shell"><span class="z-text z-plain">Valve starting at: 127.0.0.1:3000
</span><span class="z-text z-plain">Spawning plumber API at 127.0.0.1:11094
</span><span class="z-text z-plain">Spawning plumber API at 127.0.0.1:35714
</span><span class="z-text z-plain">Spawning plumber API at 127.0.0.1:15674
</span><span class="z-text z-plain">Spawning plumber API at 127.0.0.1:30746
</span><span class="z-text z-plain">Spawning plumber API at 127.0.0.1:26860
</span><span class="z-text z-plain">Spawning plumber API at 127.0.0.1:54939
</span><span class="z-text z-plain">Spawning plumber API at 127.0.0.1:5592
</span><span class="z-text z-plain">Spawning plumber API at 127.0.0.1:46549
</span><span class="z-text z-plain">Spawning plumber API at 127.0.0.1:53346
</span><span class="z-text z-plain">Spawning plumber API at 127.0.0.1:44956
</span></code></pre>
<p>If we run this again, we get something much closer to two seconds total
for sending all 10 requests.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r">start <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">Sys.time</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r">furrr<span class="z-punctuation z-accessor z-colons z-r">::</span><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">future_map</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-constant z-numeric z-float z-decimal z-r">1</span><span class="z-keyword z-other z-r">:</span><span class="z-constant z-numeric z-float z-decimal z-r">10</span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-keyword z-other z-r">~</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">sleep</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-constant z-numeric z-float z-decimal z-r">3000</span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-constant z-numeric z-float z-decimal z-r">2</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r">multi_total <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">Sys.time</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-arithmetic z-r">-</span> start
</span><span class="z-source z-r">multi_total 
</span><span class="z-source z-r"><span class="z-comment z-line z-number-sign z-r"><span class="z-punctuation z-definition z-comment z-r">#</span>&gt; Time difference of 2.013385 secs
</span></span></code></pre>
<p>Now, we can do the same thing with all 10 workers calling just one of
the spawned plumber APIs.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r">start <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">Sys.time</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r">furrr<span class="z-punctuation z-accessor z-colons z-r">::</span><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">future_map</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-constant z-numeric z-float z-decimal z-r">1</span><span class="z-keyword z-other z-r">:</span><span class="z-constant z-numeric z-float z-decimal z-r">10</span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-keyword z-other z-r">~</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">sleep</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-constant z-numeric z-float z-decimal z-r">24817</span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-constant z-numeric z-float z-decimal z-r">2</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r"><span class="z-punctuation z-section z-parens z-begin z-r">(</span>total <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">Sys.time</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-arithmetic z-r">-</span> start<span class="z-punctuation z-section z-parens z-end z-r">)</span>
</span><span class="z-source z-r"><span class="z-comment z-line z-number-sign z-r"><span class="z-punctuation z-definition z-comment z-r">#</span>&gt; Time difference of 20.04956 secs
</span></span></code></pre>
<p>That‚Äôs a huge different. That is a lot more performance that we are
squeezing out of this plumber API by creating multiple to run
concurrently.</p>
<p>In an R session load {valve}.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">library</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>valve<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></code></pre>
<p>Next, we will use the function <code>valve_run()</code> to run our plumber API.
This function has a lot of handy defaults to moderately scale your
plumber API. By default it looks for the file <code>plumber.R</code> in your
working directory.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">valve_run</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>plumber.R<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-variable z-parameter z-r">n_max</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-constant z-numeric z-float z-decimal z-r">10</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r"><span class="z-comment z-line z-number-sign z-r"><span class="z-punctuation z-definition z-comment z-r">#</span>&gt; Valve app hosted at &lt;http://127.0.0.1:3000&gt;
</span></span><span class="z-source z-r"><span class="z-comment z-line z-number-sign z-r"><span class="z-punctuation z-definition z-comment z-r">#</span>&gt; Spawning plumber API at 127.0.0.1:49015
</span></span></code></pre>
<p>The CLI works just like the R function with two differences. We call it
from the command line and the syntax is a smidgen different.</p>
<p>From the command line we can run <code>valve ‚Äìhelp</code> to see the arguments that
we can provide. The CLI has the same defaults as the R package.</p>
<pre data-lang="shell" class="language-shell z-code"><code class="language-shell" data-lang="shell"><span class="z-text z-plain">valve --help
</span><span class="z-text z-plain">Usage: valve [-h &lt;host&gt;] [-p &lt;port&gt;] [-n &lt;n-max&gt;] [-w &lt;workers&gt;] [-f &lt;file&gt;] [--check-unused &lt;check-unused&gt;] [--max-age &lt;max-age&gt;] [--n-min &lt;n-min&gt;]
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">Distribute your plumber API in parallel.
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">Options:
</span><span class="z-text z-plain">  -h, --host        host to serve APIs on
</span><span class="z-text z-plain">  -p, --port        the port to serve the main application on
</span><span class="z-text z-plain">  -n, --n-max       the maximum number of plumber APIs to spawn
</span><span class="z-text z-plain">  -w, --workers     number of Tokio workers to spawn to handle requests
</span><span class="z-text z-plain">  -f, --file        path to the plumber API (default `plumber.R`)
</span><span class="z-text z-plain">  --check-unused    default 10. Interval in seconds when to check for unused
</span><span class="z-text z-plain">                    connections
</span><span class="z-text z-plain">  --max-age         default 5 mins. How long an API can go unused before being
</span><span class="z-text z-plain">                    killed in seconds.
</span><span class="z-text z-plain">  --n-min           the maximum number of plumber APIs to spawn
</span><span class="z-text z-plain">  --help            display usage information
</span></code></pre>
<p>Now I want to illustrate scaling a machine learning model with {vetiver}
and valve. They do so by wrapping the model into a plumber API. I‚Äôve
created a sample plumber API based on <a href="https://juliasilge.com/blog/childcare-costs/">Julia‚Äôs recent Tidy Tuesday
screencast in which she creates an XGBoost
model</a>.</p>
<p><img src="https://josiah.rs/posts/valve-for-production/images/paste-14.png" alt="" /></p>
<p>I‚Äôve taken this example and used vetiver to create a plumber API to
serve predictions from this model. One could deploy this API as is with
Docker or something like Posit Connect. If going down the Docker
approach, we can make this a bit more performant by using Valve.</p>
<div class="alert-note">
<p>The scripts to generate the vetiver model and API are in the <a href="https://github.com/JosiahParry/youtube-tutorials/tree/main/intro-valve">Github
repo</a>.</p>
</div>
<p>To make this into a Valve app all we need to do is pass provide the
plumber API file to valve and we‚Äôre on our way! I‚Äôve written some simple
bench marks using drill to compare the performance of the two
approaches. With valve we will use 5 concurrent processes and test it.</p>
<pre data-lang="shell" class="language-shell z-code"><code class="language-shell" data-lang="shell"><span class="z-text z-plain">valve -f vetiver-api.R -n 5 -w 5
</span></code></pre>
</div>
    </div>
</div>
</main>

        

        <!-- Basecoat JS for interactive components -->
        <script
            src="https://josiah.rs/js/basecoat/basecoat.min.js"
            defer
        ></script>
        <!-- Basecoat sidebar component -->
        <script
            src="https://josiah.rs/js/basecoat/sidebar.min.js"
            defer
        ></script>
        <!-- Sidebar toggle for mobile -->
        <script src="https://josiah.rs/js/sidebar-toggle.js" defer></script>
        <!-- Custom tabs for panel-tabset -->
        <script src="https://josiah.rs/js/tabs.js" defer></script>
        <!-- Search functionality -->
        <script src="https://josiah.rs/js/search.js" defer></script>
        <script>
            (() => {
                const apply = (dark) => {
                    document.documentElement.classList.toggle("dark", dark);

                    // Toggle syntax highlighting themes via media attribute
                    const darkSyntax = document.getElementById("syntax-dark");
                    const lightSyntax = document.getElementById("syntax-light");
                    if (darkSyntax && lightSyntax) {
                        darkSyntax.media = dark ? "all" : "not all";
                        lightSyntax.media = dark ? "not all" : "all";
                    }

                    try {
                        localStorage.setItem(
                            "themeMode",
                            dark ? "dark" : "light",
                        );
                    } catch (_) {}
                };

                document.addEventListener("basecoat:theme", (event) => {
                    const mode = event.detail?.mode;
                    apply(
                        mode === "dark"
                            ? true
                            : mode === "light"
                              ? false
                              : !document.documentElement.classList.contains(
                                    "dark",
                                ),
                    );
                });
            })();
        </script>
        <!-- KaTeX auto-render -->
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        ></script>
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
            onload="renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ]
            });"
        ></script>
        
    </body>
</html>
