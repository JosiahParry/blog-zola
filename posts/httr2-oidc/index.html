<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>
            Implementing OpenID Connect (OIDC) in R | Josiah Parry
        </title>

        <!-- Tailwind + Basecoat CSS -->
        <link rel="stylesheet" href="https://josiah.rs/css/style.css" />

        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap" rel="stylesheet">

        <!-- Determine theme before loading syntax highlighting -->
        <script>
            (() => {
                const stored = localStorage.getItem("themeMode");
                // Use stored preference if exists, otherwise always default to dark
                const isDark = stored ? stored === "dark" : true;

                if (isDark) {
                    document.documentElement.classList.add("dark");
                }
            })();
        </script>

        <!-- Syntax highlighting themes -->
        <link rel="stylesheet" href="https://josiah.rs/syntax-dark.css" id="syntax-dark" />
        <link rel="stylesheet" href="https://josiah.rs/syntax-light.css" id="syntax-light" />

        <!-- KaTeX for math rendering -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        />

        
    </head>
    <body class="min-h-screen bg-background text-foreground">
        <main> <button
    data-drawer-target="default-sidebar"
    data-drawer-toggle="default-sidebar"
    aria-controls="default-sidebar"
    type="button"
    class="text-heading bg-transparent box-border border border-transparent hover:bg-neutral-secondary-medium focus:ring-4 focus:ring-neutral-tertiary font-medium leading-5 rounded-base ms-3 mt-3 text-sm p-2 focus:outline-none inline-flex sm:hidden"
>
    <span class="sr-only">Open sidebar</span>
    <svg
        class="w-6 h-6"
        aria-hidden="true"
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        fill="none"
        viewBox="0 0 24 24"
    >
        <path
            stroke="currentColor"
            stroke-linecap="round"
            stroke-width="2"
            d="M5 7h14M5 12h14M5 17h10"
        />
    </svg>
</button>

<aside
    id="default-sidebar"
    class="fixed top-0 left-0 z-40 w-64 h-full transition-transform -translate-x-full sm:translate-x-0"
    aria-label="Sidebar"
>
    <div class="flex h-full flex-col bg-sidebar border-e border-default">
        <!-- Header: Title + Dark Mode -->
        <div class="flex items-center justify-between p-4">
            <a
                href="https://josiah.rs"
                class="font-mono font-semibold italic text-lg"
            >
                Josiah Parry
            </a>
            <button
                type="button"
                aria-label="Toggle dark mode"
                onclick="document.dispatchEvent(new CustomEvent('basecoat:theme'))"
                class="btn-sm-ghost text-muted-foreground hover:text-foreground"
            >
                <span class="hidden dark:block">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <circle cx="12" cy="12" r="4" />
                        <path d="M12 2v2" />
                        <path d="M12 20v2" />
                        <path d="m4.93 4.93 1.41 1.41" />
                        <path d="m17.66 17.66 1.41 1.41" />
                        <path d="M2 12h2" />
                        <path d="M20 12h2" />
                        <path d="m6.34 17.66-1.41 1.41" />
                        <path d="m19.07 4.93-1.41 1.41" />
                    </svg>
                </span>
                <span class="block dark:hidden">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
                    </svg>
                </span>
            </button>
        </div>

        <!-- Search -->
        <div class="px-4 pb-4 relative">
            <input
                type="search"
                placeholder="Search..."
                class="input w-full text-sm bg-muted/50 border border-border"
                id="search-input"
            />
            <div
                id="search-results"
                class="hidden absolute top-full left-4 -mt-1 w-96 max-h-96 overflow-y-auto bg-background border border-border rounded-lg shadow-lg z-50 p-2"
            ></div>
        </div>

        <!-- Content: Navigation -->
        <div class="overflow-y-auto px-4">
            <ul class="flex flex-col gap-1">
                <li>
                    <a
                        href="https://josiah.rs"
                        class="block py-2 text-sm pl-3 transition-colors hover:bg-sidebar-accent/50"
                    >
                        Home
                    </a>
                </li>
                <li>
                    <a
                        href="https://josiah.rs/about/"
                        class="block py-2 text-sm pl-3 transition-colors hover:bg-sidebar-accent/50"
                    >
                        About
                    </a>
                </li>
                <li>
                    <a
                        href="https://josiah.rs/posts/"
                        class="block py-2 text-sm pl-3 transition-colors font-medium border-l-2 border-primary -ml-px bg-sidebar-accent"
                    >
                        Posts
                    </a>
                </li>
            </ul>

            <!-- Socials -->
            <div
                class="mt-4 block py-2 transition-colors font-medium px-3 text-sm bg-sidebar-accent"
            >
                <h2
                    class="text-sm font-medium tracking-tight mb-2 text-muted-foreground border-b border-muted-foreground/20 pb-1"
                >
                    Socials
                </h2>
                <ul class="space-y-1.5">
                    <li
                        class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 256 256"
                            class="w-4 h-4"
                        >
                            <rect width="256" height="256" fill="none" />
                            <polygon
                                points="160 128 112 96 112 160 160 128"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M24,128c0,29.91,3.07,47.45,5.41,56.47A16,16,0,0,0,39,195.42C72.52,208.35,128,208,128,208s55.48.35,89-12.58a16,16,0,0,0,9.63-10.95c2.34-9,5.41-26.56,5.41-56.47s-3.07-47.45-5.41-56.47a16,16,0,0,0-9.63-11C183.48,47.65,128,48,128,48s-55.48-.35-89,12.58a16,16,0,0,0-9.63,11C27.07,80.54,24,98.09,24,128Z"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                        </svg>
                        <a
                            href="https://www.youtube.com/@josiahparry"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-sm"
                            >YouTube</a
                        >
                    </li>
                    <li
                        class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 256 256"
                            class="w-4 h-4"
                        >
                            <rect width="256" height="256" fill="none" />
                            <rect
                                x="32"
                                y="32"
                                width="192"
                                height="192"
                                rx="8"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <line
                                x1="120"
                                y1="112"
                                x2="120"
                                y2="176"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <line
                                x1="88"
                                y1="112"
                                x2="88"
                                y2="176"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M120,140a28,28,0,0,1,56,0v36"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <circle cx="88" cy="84" r="12" />
                        </svg>
                        <a
                            href="https://www.linkedin.com/in/josiahparry"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-sm"
                            >LinkedIn</a
                        >
                    </li>
                    <li
                        class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 256 256"
                            class="w-4 h-4"
                        >
                            <rect width="256" height="256" fill="none" />
                            <path
                                d="M119.83,56A52,52,0,0,0,76,32a51.92,51.92,0,0,0-3.49,44.7A49.28,49.28,0,0,0,64,104v8a48,48,0,0,0,48,48h48a48,48,0,0,0,48-48v-8a49.28,49.28,0,0,0-8.51-27.3A51.92,51.92,0,0,0,196,32a52,52,0,0,0-43.83,24Z"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M104,232V192a32,32,0,0,1,32-32h0a32,32,0,0,1,32,32v40"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M104,208H72a32,32,0,0,1-32-32A32,32,0,0,0,8,144"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                        </svg>
                        <a
                            href="http://github.com/josiahparry/"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-sm"
                            >GitHub</a
                        >
                    </li>
                    <li
                        class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 256 256"
                            class="w-4 h-4"
                        >
                            <rect width="256" height="256" fill="none" />
                            <path
                                d="M160,224H72a32,32,0,0,1-32-32V72A32,32,0,0,1,72,40H184a32,32,0,0,1,32,32v72a32,32,0,0,1-32,32H40"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M128,136V104a24,24,0,0,0-48,0v32"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                            <path
                                d="M176,136V104a24,24,0,0,0-48,0"
                                fill="none"
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="16"
                            />
                        </svg>
                        <a
                            href="https://fosstodon.org/@josi"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-sm"
                            >Mastodon</a
                        >
                    </li>
                    <li
                        class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 16 16"
                            class="w-4 h-4"
                            fill="currentColor"
                        >
                            <path
                                d="M3.468 1.948C5.303 3.325 7.276 6.118 8 7.616c.725-1.498 2.698-4.29 4.532-5.668C13.855.955 16 .186 16 2.632c0 .489-.28 4.105-.444 4.692-.572 2.04-2.653 2.561-4.504 2.246 3.236.551 4.06 2.375 2.281 4.2-3.376 3.464-4.852-.87-5.23-1.98-.07-.204-.103-.3-.103-.218 0-.081-.033.014-.102.218-.379 1.11-1.855 5.444-5.231 1.98-1.778-1.825-.955-3.65 2.28-4.2-1.85.315-3.932-.205-4.503-2.246C.28 6.737 0 3.12 0 2.632 0 .186 2.145.955 3.468 1.948"
                            />
                        </svg>
                        <a
                            href="https://bsky.app/profile/josiahparry.com"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-sm"
                            >Bluesky</a
                        >
                    </li>
                </ul>
            </div>
        </div>
    </div>
</aside>


<div class="p-12 sm:ml-64">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-medium italic mb-2">Implementing OpenID Connect (OIDC) in R</h1>

         
        <div class="flex flex-wrap gap-2 mb-4">
            
            <a
                href="/categories/r"
                class="badge-secondary cursor pointer"
                >r</a
            >
            
            <a
                href="/categories/httr2"
                class="badge-secondary cursor pointer"
                >httr2</a
            >
            
            <a
                href="/categories/auth"
                class="badge-secondary cursor pointer"
                >auth</a
            >
            
            <a
                href="/categories/oidc"
                class="badge-secondary cursor pointer"
                >oidc</a
            >
            
        </div>
         

        <div class="flex gap-8 mb-6 text-sm">
            
            <div>
                <span class="text-muted-foreground font-mono font-medium"
                    >November 28, 2024</span
                >
            </div>
            
        </div>

        <div class="josi-prose"><p>I am working on a rust project that I want to use OpenID Connect for.
I’m struggling to wrap my head around it, so naturally, I implemented it
in R to understand it better.</p>
<h2 id="what-is-oidc">What is OIDC?</h2>
<p><a href="https://openid.net/developers/how-connect-works/">OpenID Connect
(OIDC)</a> is an
authentication standard based on OAuth 2.0. The hope is that most
identity providers (IDP) can have an implementation of OIDC so that
plugging in their authentication system is pretty straight forward.</p>
<h2 id="oidc-discovery">OIDC discovery</h2>
<p>Each OIDC provider has an
<code>{issuer_url}/.well-known/openid-configuration</code> URL which contains
information about the authentication provider. This is a public facing
document that can be used to find endpoints and other information</p>
<p>For this example, I’ve created a free account at
<a href="https://auth0.com/">Auth0</a> and made an application. I’ll store the url
in a variable called <code>issuer_url</code></p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r">issuer_url <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>https://dev-2ts7ytkts28hfj4o.us.auth0.com<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span>
</span></code></pre>
<p>Accessing the <code>openid-configuration</code> is a simple get request. We’ll
create an <code>oidc_discovery()</code> function. This will return a list and we
will give it a class <code>oidc_provider</code></p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">library</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>httr2<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r">
</span><span class="z-source z-r"><span class="z-meta z-function z-name z-r"><span class="z-entity z-name z-function z-r">oidc_discovery</span> </span><span class="z-meta z-function z-r"><span class="z-keyword z-operator z-assignment z-r">&lt;-</span> </span><span class="z-meta z-function z-r"><span class="z-storage z-type z-function z-r">function</span></span><span class="z-meta z-function z-parameters z-r"><span class="z-punctuation z-section z-parameters z-begin z-r">(</span><span class="z-variable z-parameter z-r">issuer_url</span><span class="z-punctuation z-section z-parameters z-end z-r">)</span></span> <span class="z-punctuation z-section z-braces z-begin z-r">{</span>
</span><span class="z-source z-r">  res <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">request</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>issuer_url<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span>
</span><span class="z-source z-r">    <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">req_url_path_append</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>.well-known<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>openid-configuration<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">    <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">req_perform</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span>
</span><span class="z-source z-r">    <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">resp_body_json</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">structure</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>res<span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-variable z-parameter z-r">class</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">c</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>oidc_provider<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>list<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r"><span class="z-punctuation z-section z-braces z-end z-r">}</span>
</span></code></pre>
<div>
<blockquote>
<p><strong>Tip</strong></p>
<p>I’ve also given this object a nicer print method based on the
<code>httr2_oauth_client</code> class in <a href="https://httr2.r-lib.org"><code>{httr2}</code></a>.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-meta z-function z-name z-r"><span class="z-entity z-name z-function z-r">print.oidc_provider</span> </span><span class="z-meta z-function z-r"><span class="z-keyword z-operator z-assignment z-r">&lt;-</span> </span><span class="z-meta z-function z-r"><span class="z-storage z-type z-function z-r">function</span></span><span class="z-meta z-function z-parameters z-r"><span class="z-punctuation z-section z-parameters z-begin z-r">(</span><span class="z-variable z-parameter z-r">x</span><span class="z-punctuation z-separator z-parameters z-r">,</span> <span class="z-variable z-parameter z-r">...</span><span class="z-punctuation z-section z-parameters z-end z-r">)</span></span> <span class="z-punctuation z-section z-braces z-begin z-r">{</span>
</span><span class="z-source z-r">    <span class="z-comment z-line z-number-sign z-r"><span class="z-punctuation z-definition z-comment z-r">#</span> adapted from httr2:::print.httr2_request
</span></span><span class="z-source z-r">    cli<span class="z-punctuation z-accessor z-colons z-r">::</span><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">cli_text</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>cli<span class="z-punctuation z-accessor z-colons z-r">::</span><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">style_bold</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>&lt;<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">paste</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">class</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>x<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-single z-begin z-r">[</span></span><span class="z-meta z-item-access z-r"><span class="z-meta z-item-access z-arguments z-r"><span class="z-constant z-numeric z-float z-decimal z-r">1</span></span></span><span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-single z-end z-r">]</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-variable z-parameter z-r">collapse</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>/<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>&gt;<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r">    lines <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">vapply</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">        x<span class="z-punctuation z-separator z-arguments z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">        \<span class="z-punctuation z-section z-parens z-begin z-r">(</span>.x<span class="z-punctuation z-section z-parens z-end z-r">)</span> <span class="z-punctuation z-section z-braces z-begin z-r">{</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">        <span class="z-keyword z-control z-conditional z-if z-r">if</span> <span class="z-punctuation z-section z-parens z-begin z-r">(</span><span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">is.atomic</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>.x<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">&amp;&amp;</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">length</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>.x<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">==</span> <span class="z-constant z-numeric z-float z-decimal z-r">1</span><span class="z-punctuation z-section z-parens z-end z-r">)</span> <span class="z-punctuation z-section z-braces z-begin z-r">{</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">            <span class="z-keyword z-control z-conditional z-if z-r">if</span> <span class="z-punctuation z-section z-parens z-begin z-r">(</span><span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">is.character</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>.x<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-parens z-end z-r">)</span> <span class="z-punctuation z-section z-braces z-begin z-r">{</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">                <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">paste0</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>&#39;<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> .x<span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>&#39;<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">            <span class="z-punctuation z-section z-braces z-end z-r">}</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">            <span class="z-keyword z-control z-conditional z-else z-r">else</span> <span class="z-punctuation z-section z-braces z-begin z-r">{</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">                <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">format</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>.x<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">            <span class="z-punctuation z-section z-braces z-end z-r">}</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">        <span class="z-punctuation z-section z-braces z-end z-r">}</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">        <span class="z-keyword z-control z-conditional z-else z-r">else</span> <span class="z-punctuation z-section z-braces z-begin z-r">{</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">            <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">class</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>.x<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-single z-begin z-r">[</span></span><span class="z-meta z-item-access z-r"><span class="z-meta z-item-access z-arguments z-r"><span class="z-constant z-numeric z-float z-decimal z-r">1</span></span></span><span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-single z-end z-r">]</span></span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">        <span class="z-punctuation z-section z-braces z-end z-r">}</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">        <span class="z-punctuation z-section z-braces z-end z-r">}</span><span class="z-punctuation z-separator z-arguments z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">        <span class="z-meta z-function-call z-name z-r"><span class="z-storage z-type z-r">character</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-constant z-numeric z-float z-decimal z-r">1</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    <span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r">    cli<span class="z-punctuation z-accessor z-colons z-r">::</span><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">cli_dl</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>lines<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r">    <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">invisible</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>x<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r"><span class="z-punctuation z-section z-braces z-end z-r">}</span>
</span></code></pre>
</blockquote>
</div>
<p>Using this gives us a very informative list that we will use for
identifying our authorization endpoints.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r">provider <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">oidc_discovery</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>issuer_url<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">&lt;oidc_provider&gt;
</span><span class="z-text z-plain">issuer: &#39;https://dev-2ts7ytkts28hfj4o.us.auth0.com/&#39;
</span><span class="z-text z-plain">authorization_endpoint: &#39;https://dev-2ts7ytkts28hfj4o.us.auth0.com/authorize&#39;
</span><span class="z-text z-plain">token_endpoint: &#39;https://dev-2ts7ytkts28hfj4o.us.auth0.com/oauth/token&#39;
</span><span class="z-text z-plain">device_authorization_endpoint: &#39;https://dev-2ts7ytkts28hfj4o.us.auth0.com/oauth/device/code&#39;
</span><span class="z-text z-plain">userinfo_endpoint: &#39;https://dev-2ts7ytkts28hfj4o.us.auth0.com/userinfo&#39;
</span><span class="z-text z-plain">mfa_challenge_endpoint: &#39;https://dev-2ts7ytkts28hfj4o.us.auth0.com/mfa/challenge&#39;
</span><span class="z-text z-plain">jwks_uri: &#39;https://dev-2ts7ytkts28hfj4o.us.auth0.com/.well-known/jwks.json&#39;
</span><span class="z-text z-plain">registration_endpoint: &#39;https://dev-2ts7ytkts28hfj4o.us.auth0.com/oidc/register&#39;
</span><span class="z-text z-plain">revocation_endpoint: &#39;https://dev-2ts7ytkts28hfj4o.us.auth0.com/oauth/revoke&#39;
</span><span class="z-text z-plain">scopes_supported: list
</span><span class="z-text z-plain">response_types_supported: list
</span><span class="z-text z-plain">code_challenge_methods_supported: list
</span><span class="z-text z-plain">response_modes_supported: list
</span><span class="z-text z-plain">subject_types_supported: list
</span><span class="z-text z-plain">token_endpoint_auth_methods_supported: list
</span><span class="z-text z-plain">claims_supported: list
</span><span class="z-text z-plain">request_uri_parameter_supported: FALSE
</span><span class="z-text z-plain">request_parameter_supported: FALSE
</span><span class="z-text z-plain">id_token_signing_alg_values_supported: list
</span><span class="z-text z-plain">token_endpoint_auth_signing_alg_values_supported: list
</span><span class="z-text z-plain">end_session_endpoint:
</span><span class="z-text z-plain">&#39;https://dev-2ts7ytkts28hfj4o.us.auth0.com/oidc/logout&#39;
</span></code></pre>
<p>The information in this object will be used for our oauth flows with
<code>httr2</code>.</p>
<h2 id="oidc-client-object">OIDC Client Object</h2>
<p>In httr2, we create an <code>httr2_oauth_client</code> object to be used for our
authentication flows. We will generalize that approac and create
<code>oidc_client()</code>.</p>
<p>In this function, we will store the <code>redirect_uri</code> into the client
itself as well as tack on the <code>oidc_client</code> subclass. This will give us
a nicer print method and prevent us from having to put in the
<code>redirect_uri</code> multiple times.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-meta z-function z-name z-r"><span class="z-entity z-name z-function z-r">oidc_client</span> </span><span class="z-meta z-function z-r"><span class="z-keyword z-operator z-assignment z-r">&lt;-</span> </span><span class="z-meta z-function z-r"><span class="z-storage z-type z-function z-r">function</span></span><span class="z-meta z-function z-parameters z-r"><span class="z-punctuation z-section z-parameters z-begin z-r">(</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function z-parameters z-r">  <span class="z-variable z-parameter z-r">oidc_provider</span><span class="z-punctuation z-separator z-parameters z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function z-parameters z-r">  <span class="z-variable z-parameter z-r">client_id</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">Sys.getenv</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>OIDC_CLIENT<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-separator z-parameters z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function z-parameters z-r">  <span class="z-variable z-parameter z-r">client_secret</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">Sys.getenv</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>OIDC_SECRET<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-separator z-parameters z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function z-parameters z-r">  <span class="z-variable z-parameter z-r">redirect_uri</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">oauth_redirect_uri</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></span><span class="z-source z-r"><span class="z-meta z-function z-parameters z-r"><span class="z-punctuation z-section z-parameters z-end z-r">)</span></span> <span class="z-punctuation z-section z-braces z-begin z-r">{</span>
</span><span class="z-source z-r">  client <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">oauth_client</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    <span class="z-variable z-parameter z-r">id</span> <span class="z-keyword z-operator z-assignment z-r">=</span> client_id<span class="z-punctuation z-separator z-arguments z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    <span class="z-variable z-parameter z-r">secret</span> <span class="z-keyword z-operator z-assignment z-r">=</span> client_secret<span class="z-punctuation z-separator z-arguments z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    <span class="z-variable z-parameter z-r">token_url</span> <span class="z-keyword z-operator z-assignment z-r">=</span> oidc_provider<span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-double z-begin z-r">[[</span></span><span class="z-meta z-item-access z-r"><span class="z-meta z-item-access z-arguments z-r"><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>token_endpoint<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span></span></span><span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-double z-end z-r">]]</span></span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">  <span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r">  client<span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-double z-begin z-r">[[</span></span><span class="z-meta z-item-access z-r"><span class="z-meta z-item-access z-arguments z-r"><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>redirect_uri<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span></span></span><span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-double z-end z-r">]]</span></span> <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> redirect_uri
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">class</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>client<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">c</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>oidc_client<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">class</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>client<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r">  client
</span><span class="z-source z-r"><span class="z-punctuation z-section z-braces z-end z-r">}</span>
</span></code></pre>
<p>This function fetches the client id and secret from environment
variables. This is because we do not want to store these variables
directly in our code.</p>
<div class="alert-tip">
<p>Use <code>usethis::edit_r_environ()</code> to set these variables globally.
Alternatively, you can use something like <code>config</code> to have a
<code>config.yml</code> file or an alternative environment management system. But
at the end of the day just please do not store your credentials in your
code!!!!</p>
</div>
<p>For Auth0, you have to specify which redirect URIs can be trusted. In my
case I set it to <code>http://localhost:3000/oauth/callback</code> in my
application settings.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r">client <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">oidc_client</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    provider<span class="z-punctuation z-separator z-arguments z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    <span class="z-variable z-parameter z-r">redirect_uri</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>http://localhost:3000/oauth/callback<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">&lt;oidc_client/httr2_oauth_client&gt;
</span><span class="z-text z-plain">name: bf83aacb811320e5da430601736f1286
</span><span class="z-text z-plain">id:
</span><span class="z-text z-plain">secret: &lt;REDACTED&gt;
</span><span class="z-text z-plain">token_url: https://dev-2ts7ytkts28hfj4o.us.auth0.com/oauth/token
</span><span class="z-text z-plain">auth: oauth_client_req_auth_body
</span><span class="z-text z-plain">redirect_uri: http://localhost:3000/oauth/callback
</span></code></pre>
<p>This client will now be used for our authentication steps.</p>
<h2 id="oauth2-code-flow">OAuth2 Code Flow</h2>
<p>The most secure method of authentication with OAuth2 is the code flow.
This is also the most common when building web applications. It will
send you to the external provider to authenticate there, then return you
to the app when complete with an <code>access_token</code> and an <code>id_token</code>.</p>
<p>Here we create the <code>oidc_flow_auth_code()</code> function. The authorization
endpoint will likely be different for providers. This is why we fetch it
from the provider itself.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-meta z-function z-name z-r"><span class="z-entity z-name z-function z-r">oidc_flow_auth_code</span> </span><span class="z-meta z-function z-r"><span class="z-keyword z-operator z-assignment z-r">&lt;-</span> </span><span class="z-meta z-function z-r"><span class="z-storage z-type z-function z-r">function</span></span><span class="z-meta z-function z-parameters z-r"><span class="z-punctuation z-section z-parameters z-begin z-r">(</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function z-parameters z-r">  <span class="z-variable z-parameter z-r">client</span><span class="z-punctuation z-separator z-parameters z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function z-parameters z-r">  <span class="z-variable z-parameter z-r">provider</span><span class="z-punctuation z-separator z-parameters z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function z-parameters z-r">  <span class="z-variable z-parameter z-r">scope</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>openid profile email<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span>
</span></span><span class="z-source z-r"><span class="z-meta z-function z-parameters z-r"><span class="z-punctuation z-section z-parameters z-end z-r">)</span></span> <span class="z-punctuation z-section z-braces z-begin z-r">{</span>
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">oauth_flow_auth_code</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    client<span class="z-punctuation z-separator z-arguments z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    provider<span class="z-keyword z-accessor z-dollar z-r">$</span>authorization_endpoint<span class="z-punctuation z-separator z-arguments z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    <span class="z-variable z-parameter z-r">scope</span> <span class="z-keyword z-operator z-assignment z-r">=</span> scope<span class="z-punctuation z-separator z-arguments z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    <span class="z-variable z-parameter z-r">redirect_uri</span> <span class="z-keyword z-operator z-assignment z-r">=</span> client<span class="z-keyword z-accessor z-dollar z-r">$</span>redirect_uri
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">  <span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r"><span class="z-punctuation z-section z-braces z-end z-r">}</span>
</span></code></pre>
<div class="alert-note">
<p>Now that I’m looking at this again, it may be worth storing the the
authorization endpoint into the client too…</p>
</div>
<p>When we authenticate with OIDC we most also provide the <code>openid</code> scope.
This indicates to the provider that the OIDC protocol will be used.
Additionally, OIDC uses something called json web-tokens (JWT).</p>
<p>JWTs have “claims” associated with them. This is basic informations
about the user that is authenticated. These get stored alongside the
<code>access_token</code> as an <code>id_token</code>.</p>
<p>The <a href="https://openid.net/specs/openid-connect-basic-1_0.html#StandardClaims">standard
claim</a>
<code>profile</code> will give you a lot of basic information about an end-user. It
wraps up the name, family_name, given_name, middle_name, nickname,
preferred_username, profile, picture, website, gender, birthdate,
zoneinfo, and locale claims.</p>
<p>Specify the claim you want after <code>openid</code> in the <code>scope</code> argument</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r">token <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">oidc_flow_auth_code</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">  client<span class="z-punctuation z-separator z-arguments z-r">,</span> provider<span class="z-punctuation z-separator z-arguments z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">  <span class="z-variable z-parameter z-r">scope</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>openid profile<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">&lt;httr2_token&gt;
</span><span class="z-text z-plain">token_type: Bearer
</span><span class="z-text z-plain">access_token: &lt;REDACTED&gt;
</span><span class="z-text z-plain">expires_at: 2024-11-29 11:07:12
</span><span class="z-text z-plain">id_token: &lt;REDACTED&gt;
</span><span class="z-text z-plain">scope: openid profile
</span></code></pre>
<p>With this you’ve now authenticated using OIDC. Though you may want to
access the user information in the token. We can do that by decoding the
<code>id_token</code>.</p>
<h2 id="accessing-claims">Accessing Claims</h2>
<p>Here we create a function <code>parse_id_token()</code> which takes the contents of
<code>token$id_token</code> and parses it into something human representable.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r">token<span class="z-keyword z-accessor z-dollar z-r">$</span>id_token
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImV0WWVUTjhseGJ6VENZblBMNnhxSyJ9.eyJnaXZlbl9uYW1lIjoiSm9zaWFoIiwiZmFtaWx5X25hbWUiOiJQYXJyeSIsIm5pY2tuYW1lIjoiam9zaWFoLnBhcnJ5IiwibmFtZSI6Ikpvc2lhaCBQYXJyeSIsInBpY3R1cmUiOiJodHRwczovL2xoMy5nb29nbGV1c2VyY29udGVudC5...truncate&quot;
</span></code></pre>
<p>This is base64 encoded nonsense. Below is an opinionated way to decode
this. I utilize the <a href="https://extendr.github.io/b64/"><code>{b64}</code></a> package
for fast decoding. Then use
<a href="https://coolbutuseless.github.io/package/yyjsonr/index.html"><code>{yyjsonr}</code></a>
for fast json parsing.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-meta z-function z-name z-r"><span class="z-entity z-name z-function z-r">parse_id_token</span> </span><span class="z-meta z-function z-r"><span class="z-keyword z-operator z-assignment z-r">&lt;-</span> </span><span class="z-meta z-function z-r"><span class="z-storage z-type z-function z-r">function</span></span><span class="z-meta z-function z-parameters z-r"><span class="z-punctuation z-section z-parameters z-begin z-r">(</span><span class="z-variable z-parameter z-r">token</span><span class="z-punctuation z-section z-parameters z-end z-r">)</span></span> <span class="z-punctuation z-section z-braces z-begin z-r">{</span>
</span><span class="z-source z-r">  parts <span class="z-keyword z-operator z-assignment z-r">&lt;-</span> <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">strsplit</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>token<span class="z-keyword z-accessor z-dollar z-r">$</span>id_token<span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span><span class="z-constant z-character z-escape z-r">\\</span>.<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-double z-begin z-r">[[</span></span><span class="z-meta z-item-access z-r"><span class="z-meta z-item-access z-arguments z-r"><span class="z-constant z-numeric z-float z-decimal z-r">1</span></span></span><span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-double z-end z-r">]]</span></span><span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-single z-begin z-r">[</span></span><span class="z-meta z-item-access z-r"><span class="z-meta z-item-access z-arguments z-r"><span class="z-constant z-numeric z-float z-decimal z-r">1</span><span class="z-keyword z-other z-r">:</span><span class="z-constant z-numeric z-float z-decimal z-r">2</span></span></span><span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-single z-end z-r">]</span></span>
</span><span class="z-source z-r">  b64<span class="z-punctuation z-accessor z-colons z-r">::</span><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">decode</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>parts<span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-variable z-parameter z-r">eng</span> <span class="z-keyword z-operator z-assignment z-r">=</span> b64<span class="z-punctuation z-accessor z-colons z-r">::</span><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">engine</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>url_safe_no_pad<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">    <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">lapply</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>rawToChar<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">    rlang<span class="z-punctuation z-accessor z-colons z-r">::</span><span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">set_names</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">c</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>header<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-separator z-arguments z-r">,</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>payload<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">    <span class="z-meta z-function-call z-name z-r"><span class="z-support z-function z-r">lapply</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>yyjsonr<span class="z-punctuation z-accessor z-colons z-r">::</span>read_json_str<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r"><span class="z-punctuation z-section z-braces z-end z-r">}</span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">$header
</span><span class="z-text z-plain">$header$alg
</span><span class="z-text z-plain">[1] &quot;RS256&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">$header$typ
</span><span class="z-text z-plain">[1] &quot;JWT&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">$header$kid
</span><span class="z-text z-plain">[1] &quot;redacted&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">$payload
</span><span class="z-text z-plain">$payload$given_name
</span><span class="z-text z-plain">[1] &quot;Josiah&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">$payload$family_name
</span><span class="z-text z-plain">[1] &quot;Parry&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">$payload$nickname
</span><span class="z-text z-plain">[1] &quot;josiah.parry&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">$payload$name
</span><span class="z-text z-plain">[1] &quot;Josiah Parry&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">$payload$picture
</span><span class="z-text z-plain">[1] &quot;redacted&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">$payload$updated_at
</span><span class="z-text z-plain">[1] &quot;2024-11-28T00:46:24.934Z&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">$payload$iss
</span><span class="z-text z-plain">[1] &quot;https://dev-2ts7ytkts28hfj4o.us.auth0.com/&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">$payload$aud
</span><span class="z-text z-plain">[1] &quot;mi3FRXJuJarrM7rFBDr0N270l84ANSXo&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">$payload$iat
</span><span class="z-text z-plain">[1] 1732820832
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">$payload$exp
</span><span class="z-text z-plain">[1] 1732856832
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">$payload$sub
</span><span class="z-text z-plain">[1] &quot;redacted&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">$payload$sid
</span><span class="z-text z-plain">[1] &quot;redacted&quot;
</span></code></pre>
<h2 id="authenticating-requests-with-oidc">Authenticating requests with OIDC</h2>
<p>However, you may want to wrap your requests with your OIDC auth
provider.</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-meta z-function z-name z-r"><span class="z-entity z-name z-function z-r">req_auth_oidc</span> </span><span class="z-meta z-function z-r"><span class="z-keyword z-operator z-assignment z-r">&lt;-</span> </span><span class="z-meta z-function z-r"><span class="z-storage z-type z-function z-r">function</span></span><span class="z-meta z-function z-parameters z-r"><span class="z-punctuation z-section z-parameters z-begin z-r">(</span><span class="z-variable z-parameter z-r">req</span><span class="z-punctuation z-separator z-parameters z-r">,</span> <span class="z-variable z-parameter z-r">provider</span><span class="z-punctuation z-separator z-parameters z-r">,</span> <span class="z-variable z-parameter z-r">client</span><span class="z-punctuation z-separator z-parameters z-r">,</span> <span class="z-variable z-parameter z-r">scope</span> <span class="z-keyword z-operator z-assignment z-r">=</span> <span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>openid profile email<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span><span class="z-punctuation z-section z-parameters z-end z-r">)</span></span> <span class="z-punctuation z-section z-braces z-begin z-r">{</span>
</span><span class="z-source z-r">  req <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">    <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">req_oauth_auth_code</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">      <span class="z-variable z-parameter z-r">client</span> <span class="z-keyword z-operator z-assignment z-r">=</span> client<span class="z-punctuation z-separator z-arguments z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">      <span class="z-variable z-parameter z-r">auth_url</span> <span class="z-keyword z-operator z-assignment z-r">=</span> provider<span class="z-keyword z-accessor z-dollar z-r">$</span>authorization_endpoint<span class="z-punctuation z-separator z-arguments z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">      <span class="z-variable z-parameter z-r">scope</span> <span class="z-keyword z-operator z-assignment z-r">=</span> scope<span class="z-punctuation z-separator z-arguments z-r">,</span>
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">      <span class="z-variable z-parameter z-r">redirect_uri</span> <span class="z-keyword z-operator z-assignment z-r">=</span> client<span class="z-keyword z-accessor z-dollar z-r">$</span>redirect_uri
</span></span><span class="z-source z-r"><span class="z-meta z-function-call z-arguments z-r">    <span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r"><span class="z-punctuation z-section z-braces z-end z-r">}</span>
</span></code></pre>
<h2 id="accessing-userinfo">Accessing <code>UserInfo</code></h2>
<p>Each OIDC provider also has a <code>UserInfo</code> endpoint that can be accessed
for user-level claims.</p>
<p>We can wrap this up as well:</p>
<pre data-lang="r" class="language-r z-code"><code class="language-r" data-lang="r"><span class="z-source z-r"><span class="z-meta z-function z-name z-r"><span class="z-entity z-name z-function z-r">oidc_user_info</span> </span><span class="z-meta z-function z-r"><span class="z-keyword z-operator z-assignment z-r">&lt;-</span> </span><span class="z-meta z-function z-r"><span class="z-storage z-type z-function z-r">function</span></span><span class="z-meta z-function z-parameters z-r"><span class="z-punctuation z-section z-parameters z-begin z-r">(</span><span class="z-variable z-parameter z-r">provider</span><span class="z-punctuation z-separator z-parameters z-r">,</span> <span class="z-variable z-parameter z-r">token</span><span class="z-punctuation z-section z-parameters z-end z-r">)</span></span> <span class="z-punctuation z-section z-braces z-begin z-r">{</span>
</span><span class="z-source z-r">  <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">request</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>provider<span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-double z-begin z-r">[[</span></span><span class="z-meta z-item-access z-r"><span class="z-meta z-item-access z-arguments z-r"><span class="z-string z-quoted z-double z-r"><span class="z-punctuation z-definition z-string z-begin z-r">&quot;</span>userinfo_endpoint<span class="z-punctuation z-definition z-string z-end z-r">&quot;</span></span></span></span><span class="z-meta z-item-access z-r"><span class="z-punctuation z-section z-brackets z-double z-end z-r">]]</span></span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">    <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">req_auth_bearer_token</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span>token<span class="z-keyword z-accessor z-dollar z-r">$</span>access_token<span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">    <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">req_perform</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span> <span class="z-keyword z-operator z-logical z-r">|</span><span class="z-keyword z-operator z-logical z-r">&gt;</span> 
</span><span class="z-source z-r">    <span class="z-meta z-function-call z-name z-r"><span class="z-variable z-function z-r">resp_body_json</span></span><span class="z-meta z-function-call z-arguments z-r"><span class="z-punctuation z-section z-arguments z-begin z-r">(</span><span class="z-punctuation z-section z-arguments z-end z-r">)</span></span>
</span><span class="z-source z-r"><span class="z-punctuation z-section z-braces z-end z-r">}</span>
</span></code></pre>
<p>Note that this will only give you the user information that is
associated with the claims used to authenticate with as well.</p>
</div>
    </div>
</div>
</main>

        

        <!-- Basecoat JS for interactive components -->
        <script
            src="https://josiah.rs/js/basecoat/basecoat.min.js"
            defer
        ></script>
        <!-- Basecoat sidebar component -->
        <script
            src="https://josiah.rs/js/basecoat/sidebar.min.js"
            defer
        ></script>
        <!-- Sidebar toggle for mobile -->
        <script src="https://josiah.rs/js/sidebar-toggle.js" defer></script>
        <!-- Custom tabs for panel-tabset -->
        <script src="https://josiah.rs/js/tabs.js" defer></script>
        <!-- Search functionality -->
        <script src="https://josiah.rs/js/search.js" defer></script>
        <script>
            (() => {
                const apply = (dark) => {
                    document.documentElement.classList.toggle("dark", dark);

                    // Toggle syntax highlighting themes via media attribute
                    const darkSyntax = document.getElementById("syntax-dark");
                    const lightSyntax = document.getElementById("syntax-light");
                    if (darkSyntax && lightSyntax) {
                        darkSyntax.media = dark ? "all" : "not all";
                        lightSyntax.media = dark ? "not all" : "all";
                    }

                    try {
                        localStorage.setItem(
                            "themeMode",
                            dark ? "dark" : "light",
                        );
                    } catch (_) {}
                };

                document.addEventListener("basecoat:theme", (event) => {
                    const mode = event.detail?.mode;
                    apply(
                        mode === "dark"
                            ? true
                            : mode === "light"
                              ? false
                              : !document.documentElement.classList.contains(
                                    "dark",
                                ),
                    );
                });
            })();
        </script>
        <!-- KaTeX auto-render -->
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        ></script>
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
            onload="renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ]
            });"
        ></script>
        
    </body>
</html>
